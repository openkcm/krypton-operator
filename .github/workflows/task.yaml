name: task

on:
  push:
    branches: [ feature/init ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *' # Every day at midnight UTC

permissions:
  id-token: write
  contents: read
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive  # fetch all nested submodules
          fetch-depth: 0         # full history (needed for tags/versioning)

      - name: Init & verify submodules
        run: |
          git submodule sync --recursive || true
          git submodule update --init --recursive || true
          echo "Submodule status:" && git submodule status || true
          echo "Expect Taskfile at hack/common/Taskfile_controller.yaml"
          if [ ! -f hack/common/Taskfile_controller.yaml ]; then
            echo "ERROR: Missing hack/common/Taskfile_controller.yaml"
            echo "Listing hack/common:"; ls -al hack/common || true; find . -maxdepth 4 -name 'Taskfile_controller.yaml'
            exit 1
          fi

      - name: Install Task
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b .
          ./task --version
        working-directory: ${{ github.workspace }}

      - name: Run Taskfile pipeline
        run: |
          ./task image
        working-directory: ${{ github.workspace }}
